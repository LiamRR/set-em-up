- name: Install basic development tools.
  ansible.builtin.apt:
    name:
      - git
      - curl
      - wget
      - gnupg
      - software-properties-common
      - apt-transport-https
      - ca-certificates
      - python3
      - python3-pip
    state: present
  when: ansible_os_family == "Debian"

- name: Install basic development tools.
  ansible.builtin.dnf:
    name:
      - git
      - curl
      - wget
      - gnupg2
      - python3
      - python3-pip
    state: present
  when: ansible_os_family == "RedHat"

# Terraform installation
- name: Terraform task block (Debian).
  when: ansible_os_family == "Debian"
  ansible.builtin.block:
    - name: Add HashiCorp GPG key.
      ansible.builtin.apt_key:
        url: https://apt.releases.hashicorp.com/gpg
        state: present

    - name: Add HashiCorp repository.
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
        state: present

    - name: Install Terraform.
      ansible.builtin.apt:
        name: terraform
        state: present
        update_cache: true

- name: Terraform task block (Redhat).
  when: ansible_os_family == "RedHat"
  ansible.builtin.block:
    - name: Add HashiCorp repository.
      ansible.builtin.yum_repository:
        name: hashicorp
        description: HashiCorp Stable - $basearch
        baseurl: https://rpm.releases.hashicorp.com/RHEL/$releasever/$basearch/stable
        gpgkey: https://rpm.releases.hashicorp.com/gpg
        gpgcheck: true
        enabled: true

    - name: Install Terraform.
      ansible.builtin.dnf:
        name: terraform
        state: present

# AWS CLI v2 installation
- name: Download AWS CLI installer (Debian family)
  ansible.builtin.get_url:
    url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
    dest: /tmp/awscliv2.zip
    mode: '0644'
  when: ansible_os_family == "Debian"

- name: Extract AWS CLI installer (Debian family)
  ansible.builtin.unarchive:
    src: /tmp/awscliv2.zip
    dest: /tmp
    remote_src: true
  when: ansible_os_family == "Debian"

- name: Install AWS CLI v2 (Debian family)
  ansible.builtin.command: /tmp/aws/install --update
  args:
    creates: /usr/local/bin/aws
  when: ansible_os_family == "Debian"

- name: Install AWS CLI v2 (RedHat family)
  ansible.builtin.dnf:
    name: awscli
    state: present
  when: ansible_os_family == "RedHat"

# Docker installation (Debian)
- name: Docker installation.
  when: ansible_os_family == "Debian"
  ansible.builtin.block:
    - name: Create apt keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Docker GPG key (Debian family)
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository (Debian family)
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker (Debian family)
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: true

# Docker installation (RedHat)
- name: Docker installation.
  when: ansible_os_family == "RedHat"
  ansible.builtin.block:
    - name: Add Docker repository (RedHat family)
      ansible.builtin.yum_repository:
        name: docker-ce-stable
        description: Docker CE Stable - $basearch
        baseurl: https://download.docker.com/linux/centos/$releasever/$basearch/stable
        gpgkey: https://download.docker.com/linux/centos/gpg
        gpgcheck: true
        enabled: true

    - name: Install Docker (RedHat family)
      ansible.builtin.dnf:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
